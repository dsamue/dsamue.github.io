<html>
<head>
  <title>A D3 chart</title>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="json-world.js"></script>
</head>
<body>


  <input type="button" onclick="wave=1;readData();" value="First Wave" />
  <input type="button" onclick="wave=2;readData();" value="Second Wave" />
  <input type="button" onclick="wave=3;readData();" value="Third Wave" />
  <input type="button" onclick="wave=4;readData();" value="Fourth Wave" />

  <p>Choose variable:
  <input type="radio" name="variable" id="happniess" value="happniess" onclick="variable='happiness';makeMap();" checked="checked" />
  Happniess
  <input type="radio" name="variable" id="family" value="family" onclick="variable='family';makeMap();" />
  Family
  <input type="radio" name="variable" id="friends" value="friends" onclick="variable='friends';makeMap();" /> 
  Friends
  <input type="radio" name="variable" id="parents" value="parents" onclick="variable='parents';makeMap();" /> 
  parents
  <input type="radio" name="variable" id="politics" value="politics" onclick="variable='politics';makeMap();" /> 
  Politics
  <input type="radio" name="variable" id="religion" value="religion" onclick="variable='religion';makeMap();" /> 
  Religion
  <input type="radio" name="variable" id="work" value="work" onclick="variable='work';makeMap();" /> 
  Work
  <input type="radio" name="variable" id="health" value="health" onclick="variable='health';makeMap();" /> 
  Health
  </p>


  <script>

//Skapar en global variabel för data
var myData;
var currentIndex = 0;
var variable = "happiness";
var wave = 0
var countryName;


var svg = d3.select( "body" )
            .append( "svg" )
              .attr( "width", 300 )
              .attr( "height", 300 );

  var width = 1000,
      height = 800;


  var svgMap = d3.select( "body" )
    .append( "svg" )
    .attr( "width", width )
    .attr( "height", height );


//Läs in data
function readData(){

  //svg.selectAll("svg").remove();

  //read default wave and make map
  if(wave === 0){

    d3.csv("wave3.csv", function(data){
      wave = 1;
      myData = data;
      makeMap();
      makeList(myData);
      drawChart("World");
    });
  }

  //read wave 1 and update map
  if(wave === 1){

    d3.csv("wave3.csv", function(data){
      myData = data;
      makeMap();
      drawChart(countryName);
    });
  }

  //read wave 2 and update map
  else if(wave === 2){

    d3.csv("wave4.csv", function(data){
      myData = data;
      makeMap();
      drawChart(countryName);
    });
  }

    //read wave 3 and update map
  else if(wave === 3){

    d3.csv("wave5.csv", function(data){
      myData = data;
      makeMap();
      drawChart(countryName);
    });
  }

  //read wave 4 and update map
  else if(wave === 4){

    d3.csv("wave6.csv", function(data){
    myData = data;
    makeMap();
    drawChart(countryName);
    });
  }
  //makeMap();
}




//Rita diagram
function drawChart( dataArray ){

  if (typeof dataArray === "string"){
    for (i = 0; i < myData.length; i++) { 
      if(dataArray === myData[i].country){
        countryName = myData[i].country;
        // console.log(countryName);
        // console.log(myData[i].happiness);

        //Om landet saknar data vid klick eller byte av våg:
        if(myData[i].happiness == undefined){
          //d3.select("svg").selectAll("rect").remove();
          dataArray = [0,0,0,0,0,0,0,0];
          //alert("Sorry, no data for this wave.");
        }

        else{
          dataArray = [ myData[i].happiness, myData[i].family, myData[i].friends, myData[i].parents, myData[i].politics, myData[i].religion, myData[i].work, myData[i].health ];
        }
       // country,happiness,family,friends,parents,politics,religion,work,health

      }
    }
    //Om man klickar på ett land som inte finns
    if (typeof dataArray === "string"){
      //d3.select("svg").selectAll("rect").remove();
      alert("Sorry, no data for this country.");
      //drawChart("World");
      return;
    }


  }

  //Remove old text
  var textSelection = svg.selectAll("text")
                        .data( dataArray );
  
  textSelection.exit()
      .remove();


      // create a selection
  var selection = svg.selectAll( "rect" )
                       .data( dataArray );



    // create new elements wherever needed                   
    selection.enter()
      .append( "rect" )
      .attr( "y", function(d,i){
        return i*25;
      })
      .attr( "height", 15 )
      .attr( "fill", "#d1c9b8" )
      //Klicka på en stapel för att ta bort
      .on( "click", function(){
        d3.select(this).remove();
      });

    // set bar heights based on data
    selection
      .attr( "width", function(d){
        return d/10 * 15;
      })
      .attr( "x", function(d){
        return 100;
      });
    
    //Skriv ut etiketter
    svg.selectAll("text")
      .data(dataArray)
      .enter()
        .append("text")
        .attr("fill", "black")
        .attr("x", function(d, i) { return 5; })
        .attr("y", function(d, i) { return (i * 25) + 15; })
        .text(function (d,i) { if(i==0){ return "Happniess";}
                               if(i==1){ return "Family";}
                               if(i==2){ return "Friends";}
                               if(i==3){ return "parents";}
                               if(i==4){ return "Politics";}
                               if(i==5){ return "Religion";}
                               if(i==6){ return "Work";}
                               if(i==7){ return "Health";}


         })
        

    // remove any unused bars
    selection.exit()
      .remove();

  // Skriv ut Land
  //console.log(countryName + "!");
  svg.append("text")
        .attr("x", 100)             
        .attr("y", 220) 
        .style("font-size", "24px")   
        .text(countryName)
        .append('svg:tspan')  //fixar radbryt-ish
        .attr("x", 100)             
        .attr("y", 240) 
        .style("font-size", "16px")   
        .text("Wave: " + wave )

        //Om data saknas
        if(dataArray[0]==0){
          console.log("funkar");
         svg.append("text") 
        .attr("x", 100)             
        .attr("y", 260) 
        .style("font-size", "16px")   
        .text("No data")
        }
}



//Skapa karta
function makeMap(){

  //d3.select("svgMap").remove();


  var g = svgMap.append( "g" );

  var albersProjection = d3.geo.mercator()
    .scale( 160 )
    .rotate( [71.057,0] )
    .center( [0, 42.313] )
    .translate( [width/2,height/2] );

  var geoPath = d3.geo.path()
      .projection( albersProjection );

  g.selectAll( "path" )
    .data( world_json.features )
    .enter()
    .append( "path" )
    .attr( "fill", function(d){
      for (i = 0; i < myData.length; i++) { 
        //console.log(i);
        if(d.properties.name === myData[i].country){
          // var color = d3.scale()
          //   .domain([0, 100])
          //   .range(["red", "green"]);

          var color = d3.scale.linear().domain([0,50,100]).range(["#EB382F","#FFFE5D","#A8FB54"]);

            //console.log(myData[i][variable]);
            return color(myData[i][variable]); 


          //return "#0f0";
        }
      }
      return "#ccc";
    })
    .attr( "d", geoPath )
    .on("click", function(d){
      drawChart(d.properties.name);
      currentIndex = getIndex(d.properties.name);
      // console.log(currentIndex);
      // console.log(d.properties.name);
    });

    // // remove old map
    // selection.exit()
    //   .remove();
  }

  // function updateMap(){

  // var g = svgMap.append( "g" );

  // var albersProjection = d3.geo.mercator()
  //   .scale( 160 )
  //   .rotate( [71.057,0] )
  //   .center( [0, 42.313] )
  //   .translate( [width/2,height/2] );

  // var geoPath = d3.geo.path()
  //     .projection( albersProjection );
  //   var g = svgMap.append( "g" );

  //     g.selectAll( "path" )
  //   .data( world_json.features )
  //   .enter()
  //   .append( "path" )
  //   .attr( "fill", function(d){
  //     for (i = 0; i < myData.length; i++) { 
  //       //console.log(i);
  //       if(d.properties.name === myData[i].country){
  //         // var color = d3.scale()
  //         //   .domain([0, 100])
  //         //   .range(["red", "green"]);

  //         var color = d3.scale.linear().domain([0,50,100]).range(["#EB382F","#FFFE5D","#A8FB54"]);

  //           console.log(myData[i].happiness);
  //           return color(myData[i][variable]);


  //         //return "#0f0";
  //       }
  //     }
  //     return "#ccc";
  //   })
  //   .attr( "d", geoPath )
  //   .on("click", function(d){
  //     drawChart(d.properties.name);
  //     currentIndex = getIndex(d.properties.name);
  //     // console.log(currentIndex);
  //     // console.log(d.properties.name);
  //   });
  // }

  //Skapa lista //bara anropad för wave1 i nuläget
  function makeList( dataArray ){

  // create a selection
  var body = d3.select( "body" );

  //rensa bort dom utan data //Av någon anledning så bråkar denna med att klicka på ett land utan data.. rensar även orginaldata?
  // for(i=0; i<dataArray.length; i++){
  //   //console.log(dataArray[i]);
  //   if (dataArray[i].happiness == undefined){
  //     //console.log("hej");
  //     var dataArray = dataArray.splice(i,1);
  //     console.log(dataArray.length)

  //   }
  // }

//Sortering, funkar inte helt med att köra in variable  
  dataArray.sort(function(x,y){
    console.log(variable);
   return d3.descending(x.happiness, y.happiness);
})

  var selection = body.selectAll( "p" )
                       .data( dataArray );
  
  selection.enter()
    .append("p")
    .text(function(d){
      return d.country;
    })
    .on( "click", function(d){
      countryName = d.country;
      drawChart(d.country);    //Ok, denna är inte uppdaterad efter ny data. 
    });            
  }


  function getIndex(name){
    for (i = 0; i < myData.length; i++) { 
      if(name === myData[i].country){
        return i;
      }
    }
  }


function obj2Arr(object){
  //countryName = object.country;    //genom att toggla den här kan jag få mina två olika fellägen med titlarn om den nedanförskickar arrayen?
  return object.country;//[ object.happiness, object.family, object.friends, object.parents, object.politics, object.religion, object.work, object.health ];
}

readData("0");


  </script>
  
</body>
</html>